name: Pull from note

on:
  schedule:
    - cron: '*/15 * * * *'  # 15分ごと
  workflow_dispatch:  # 手動実行も可能

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Pull from note
        id: pull
        env:
          NOTE_MCP_URL: ${{ secrets.NOTE_MCP_URL }}
        run: |
          CONFLICTS=""
          UPDATED=""
          
          for meta in articles/*/meta.json; do
            slug=$(basename $(dirname $meta))
            
            # note 側が編集中の記事のみ pull
            location=$(jq -r '.editing.location // "none"' $meta)
            
            if [ "$location" = "note" ]; then
              echo "Pulling $slug..."
              if node scripts/note-sync.js pull "$slug"; then
                UPDATED="$UPDATED $slug"
              else
                if [ -f "articles/$slug/index.CONFLICT.md" ]; then
                  CONFLICTS="$CONFLICTS $slug"
                fi
              fi
            fi
          done
          
          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "conflicts=$CONFLICTS" >> $GITHUB_OUTPUT
      
      - name: Commit changes
        if: steps.pull.outputs.updated != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add articles/
          git diff --staged --quiet || git commit -m "chore: pull from note [skip ci]"
          git push
      
      - name: Create PR for conflicts
        if: steps.pull.outputs.conflicts != ''
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "⚠️ Resolve note sync conflicts"
          title: "⚠️ note sync conflicts detected"
          body: |
            ## 競合検知
            
            以下の記事で note 側の変更と Obsidian 側の変更が競合しました：
            
            ${{ steps.pull.outputs.conflicts }}
            
            ### 対処方法
            
            1. 各記事の `index.CONFLICT.md` を確認
            2. 必要な内容を `index.md` にマージ
            3. `index.CONFLICT.md` を削除
            4. この PR をマージ
            
            ### 自動マージが失敗した理由
            
            両方で同じ箇所が編集されている可能性があります。
            手動でマージしてください。
          branch: note-sync-conflicts-${{ github.run_number }}
          delete-branch: true

